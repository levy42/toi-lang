from lib.test import assert_eq, assert_true

dir = import dir
os = import os
io = import io

ROOT = "tests/tmp_dir_case"

fn safe_rm(path)
  if os.exists(path)
    os.remove(path)

fn safe_rmdir(path)
  if os.exists(path) and os.isdir(path)
    os.rmdir(path)

safe_rm(ROOT + "/a.txt")
safe_rm(ROOT + "/b.log")
safe_rmdir(ROOT + "/sub")
safe_rmdir(ROOT)

local ok, err = os.mkdir(ROOT)
assert_true(ok == true)
local ok2, err2 = os.mkdir(ROOT + "/sub")
assert_true(ok2 == true)

f = io.open(ROOT + "/a.txt", "w")
f.write("a")
f.close()

f = io.open(ROOT + "/b.log", "w")
f.write("b")
f.close()

local names, e1 = dir.list(ROOT)
assert_true(names != nil, "dir.list failed")
found_a = false
found_b = false
found_sub = false
for n in names
  if n == "a.txt"
    found_a = true
  if n == "b.log"
    found_b = true
  if n == "sub"
    found_sub = true
assert_true(found_a)
assert_true(found_b)
assert_true(found_sub)

local rows, e2 = dir.scandir(ROOT)
assert_true(rows != nil, "dir.scandir failed")
has_row = false
for r in rows
  if r.name == "a.txt"
    has_row = true
    assert_eq(r.path, ROOT + "/a.txt")
    assert_true(type(r.type) == "string")
assert_true(has_row)

local none, e3 = dir.list("tests/does_not_exist___dir")
assert_true(none == nil)
assert_true(e3 != nil)

safe_rm(ROOT + "/a.txt")
safe_rm(ROOT + "/b.log")
safe_rmdir(ROOT + "/sub")
safe_rmdir(ROOT)

print "dir ok"
