json = import json
time = import time
global string = import string

fn assert_true(cond, msg = nil)
  if not cond
    error(msg or "assert_true failed")

payload = {
  name = "Ada",
  active = true,
  score = 98.5,
  tags = {"pua", "json", "perf"},
  nested = {
    retries = 3,
    timeout_ms = 250,
    ok = true
  },
  users = {
    {id = 1, role = "admin"},
    {id = 2, role = "staff"},
    {id = 3, role = "member"}
  }
}

-- Correctness sanity
encoded = json.encode(payload)
assert_true(type(encoded) == "string", "json.encode should return string")

decoded = json.decode(encoded)
assert_true(type(decoded) == "table", "json.decode should return table")
assert_true(decoded.name == "Ada", "decoded.name mismatch")
assert_true(decoded.active == true, "decoded.active mismatch")
assert_true(decoded.nested.retries == 3, "decoded nested mismatch")
assert_true(decoded.tags[1] == "pua", "decoded array mismatch")
assert_true(decoded.users[3].role == "member", "decoded array object mismatch")

-- Benchmark encode
encode_iters = 4000
start = time.clock()
i = 1
while i <= encode_iters
  encoded = json.encode(payload)
  i = i + 1
encode_elapsed = time.clock() - start
assert_true(encode_elapsed >= 0, "encode benchmark clock went backwards")

-- Benchmark decode
decode_iters = 4000
start = time.clock()
i = 1
while i <= decode_iters
  decoded = json.decode(encoded)
  i = i + 1
decode_elapsed = time.clock() - start
assert_true(decode_elapsed >= 0, "decode benchmark clock went backwards")

print string.format("json perf: encode=%fs decode=%fs payload_bytes=%d", encode_elapsed, decode_elapsed, #encoded)
