from lib.test import assert_eq, assert_true

toml = import toml
table = import table

doc = table.concat({
  "title = \"TOML Example\"",
  "enabled = true",
  "count = 42",
  "ratio = 3.5",
  "tags = [\"a\", \"b\", \"c\"]",
  "created_at = 1979-05-27T07:32:00Z",
  "point = {x = 1, y = 2}",
  "",
  "[server]",
  "host = \"127.0.0.1\"",
  "port = 8080",
  "",
  "[server.tls]",
  "enabled = false",
  "",
  "[[products]]",
  "name = \"Hammer\"",
  "sku = 738594937",
  "",
  "[[products]]",
  "name = \"Nail\"",
  "sku = 284758393",
  "color = \"gray\"",
  ""
}, "\n")

t = toml.parse(doc)
assert_eq(t.title, "TOML Example")
assert_eq(t.enabled, true)
assert_eq(t.count, 42)
assert_eq(t.ratio, 3.5)
assert_eq(t.tags[2], "b")
assert_eq(t.created_at, "1979-05-27T07:32:00Z")
assert_eq(t.point.x, 1)
assert_eq(t.point.y, 2)
assert_eq(t.server.host, "127.0.0.1")
assert_eq(t.server.port, 8080)
assert_eq(t.server.tls.enabled, false)
assert_eq(#t.products, 2)
assert_eq(t.products[1].name, "Hammer")
assert_eq(t.products[2].sku, 284758393)
assert_eq(t.products[2].color, "gray")

with_dotted = toml.parse([[
[db]
conn.host = "localhost"
conn.port = 5432
]])
assert_eq(with_dotted.db.conn.host, "localhost")
assert_eq(with_dotted.db.conn.port, 5432)

serialized = toml.stringify(t)
t2 = toml.parse(serialized)
assert_eq(t2.title, "TOML Example")
assert_eq(t2.enabled, true)
assert_eq(t2.count, 42)
assert_eq(t2.tags[3], "c")
assert_eq(t2.created_at, "1979-05-27T07:32:00Z")
assert_eq(t2.point.x, 1)
assert_eq(t2.server.tls.enabled, false)
assert_eq(#t2.products, 2)
assert_eq(t2.products[2].name, "Nail")

bad = false
try
  toml.parse("x = ")
except e
  bad = true
  if type(e) == "table"
    assert_true(e.msg has "expected value")
  else
    assert_true(e has "expected value")
assert_true(bad)

print "toml ok"
