from lib.test import assert_eq

string = import string

t = { base = 2 }
t.add = fn(self, x)
  return self.base + x

t.mul = fn(x, y)
  return x * y

assert_eq(t.add(3), 5)
assert_eq(t.mul(2, 3), 6)

assert_eq("abc".upper(), "ABC")

from lib.test import assert_eq, assert_true

thread = import thread

global i = 99

fn worker_implicit_local()
  i = 1
  while i <= 10
    i = i + 1
  return i

h1 = thread.spawn(worker_implicit_local)
assert_true(h1 != nil, "spawn worker_implicit_local failed")
r1 = thread.join(h1)
assert_eq(r1, 11)
assert_eq(i, 99)

global i = 99

fn worker_declares_global()
  global i
  i = 1
  while i <= 10
    i = i + 1
  return i

h2 = thread.spawn(worker_declares_global)
assert_true(h2 != nil, "spawn worker_declares_global failed")
r2 = thread.join(h2)
assert_eq(r2, 11)
assert_eq(i, 11)

print "thread global declaration scope ok"

from lib.test import assert_eq

global gx = "global"

fn f()
  gx = gx or "local"
  return gx

assert_eq(f(), "local")
assert_eq(gx, "global")

print "forward local assignment ok"
