fn assert_true(cond, msg = nil)
  if not cond
    error("assert_true failed")

fn assert_eq(actual, expected, msg = nil)
  if actual != expected
    error("assert_eq failed")

-- types module
types = import lib.types
from lib.types import String, Integer
local ok1, err1 = types.String.check("hi")
assert_true(ok1)
local ok1b, err1b = String.check("hi")
assert_true(ok1b)
local ok1c, err1c = Integer.check(42)
assert_true(ok1c)

User = types.Record {
  name = types.String,
  age = types.Integer
}
u = User {name = "Max", age = 21}
local ok_user_inst, err_user_inst = u.check()
assert_true(ok_user_inst)

bad_u = User {name = 10, age = "x"}
local ok_bad_u, err_bad_u = bad_u.check()
assert_true(not ok_bad_u)
assert_true(err_bad_u has "$.name" or err_bad_u has "$.age")

str_list = types.List(types.String)
local ok2, err2 = str_list.check({"a", "b", "c"})
assert_true(ok2)
local ok3, err3 = str_list.check({"a", 2})
assert_true(not ok3)

local ok4, err4 = str_list.check({[1] = "a", [3] = "c"})
assert_true(not ok4)
local ok5, err5 = str_list.check({[1] = "a", x = "b"})
assert_true(not ok5)

opt_num = types.Optional(types.Number)
local ok6, err6 = opt_num.check(nil)
assert_true(ok6)
local ok7, err7 = opt_num.check(1.5)
assert_true(ok7)
local ok8, err8 = opt_num.check("1")
assert_true(not ok8)

person_t = types.Record({
  name = types.String,
  age = types.Integer
})
local ok9, err9 = person_t.check({name = "Ada", age = 36})
assert_true(ok9)
local ok10, err10 = person_t.check({name = "Ada"})
assert_true(not ok10)

strict_person_t = types.Record({name = types.String}, {allow_extra = false})
local ok11, err11 = strict_person_t.check({name = "Ada", extra = 1})
assert_true(not ok11)

local ok12, err12 = types.validate(types.Integer, 10)
assert_true(ok12)
local ok13, err13 = types.validate(types.Integer, 10.5)
assert_true(not ok13)
assert_true(err13 has "$")

-- Literal
role_t = types.Literal("admin", "staff")
local ok14, err14 = role_t.check("admin")
assert_true(ok14)
local ok15, err15 = role_t.check("guest")
assert_true(not ok15)
assert_true(err15 has "$")

-- Union
id_t = types.Union(types.String, types.Integer)
local ok16, err16 = id_t.check("u-1")
assert_true(ok16)
local ok17, err17 = id_t.check(123)
assert_true(ok17)
local ok18, err18 = id_t.check(false)
assert_true(not ok18)
assert_true(err18 has "$")

-- Constraints
adult_t = types.Constraints(types.Integer, {min = 18, max = 120})
local ok19, err19 = adult_t.check(30)
assert_true(ok19)
local ok20, err20 = adult_t.check(15)
assert_true(not ok20)
assert_true(err20 has "$")

name_t = types.Constraints(types.String, {min_len = 2, max_len = 10, pattern = "a"})
local ok21, err21 = name_t.check("adam")
assert_true(ok21)
local ok22, err22 = name_t.check("x")
assert_true(not ok22)
assert_true(err22 has "$")

-- Path-aware nested errors
profile_t = types.Record({
  user = types.Record({
    name = types.String,
    age = types.Constraints(types.Integer, {min = 18})
  })
})

local ok23, err23 = profile_t.check({user = {name = 42, age = 20}})
assert_true(not ok23)
assert_true(err23 has "$.user.name")

local ok24, err24 = profile_t.check({user = {name = "Ada", age = 15}})
assert_true(not ok24)
assert_true(err24 has "$.user.age")

-- coercion
local ok25, err25, v25 = types.coerce(types.Integer, "42")
assert_true(ok25)
assert_eq(v25, 42)

local ok26, err26 = types.validate(types.Integer, "42")
assert_true(not ok26)

local ok27, err27, v27 = types.coerce(types.Boolean, "true")
assert_true(ok27)
assert_true(v27 == true)

coerce_t = types.Record({age = types.Integer, scores = types.List(types.Number), active = types.Boolean})
local ok28, err28, v28 = types.coerce(coerce_t, {age = "21", scores = {"1.5", "2"}, active = "1"})
assert_true(ok28)
assert_eq(v28.age, 21)
assert_eq(v28.scores[1], 1.5)
assert_eq(v28.scores[2], 2)
assert_true(v28.active == true)

-- scheduler module
sched = import scheduler
done = 0
sched.add(fn()
  done = done + 1
)
sched.run()
assert_eq(done, 1)

-- http server module (import only)
http_server = import http_server
assert_true(type(http_server) == "table")
assert_true(type(http_server.new) == "function")

print "pua libs ok"
