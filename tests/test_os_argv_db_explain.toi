from lib.test import assert_eq, assert_true

os = import os

assert_true(type(os.argv) == "table")
assert_true(type(os.argc) == "number")
assert_eq(os.argc, #os.argv)
assert_eq(os.argc, 0)
print "os argv ok"

from lib.test import assert_eq, assert_true

os = import os
types = import lib.types
db_mod = import lib.db

base = "tests/tmp_db_explain"
os.remove(base + "_users.db")
os.remove(base + "_users__idx_email.db")
os.remove(base + "_users__idx_team.db")
os.remove(base + "_users__idx_age.db")

User = types.Record {
  id = types.String,
  name = types.String,
  email = types.String,
  team = types.String,
  age = types.Integer
}
User.__name = "users"
User.__indexes = {
  {field = "email", unique = true},
  "team",
  "age"
}

db = db_mod.open(base)
users = db.create_table(User)

db.add(User {name = "Ana", email = "ana@example.com", team = "red", age = 31})
db.add(User {name = "Bob", email = "bob@example.com", team = "red", age = 24})
db.add(User {name = "Cid", email = "cid@example.com", team = "blue", age = 17})

plan1 = users.explain(team = "red", age__gte = 24, order_by = "-age", limit = 2, offset = 0)
assert_true(type(plan1) == "table")
assert_true(plan1.index_accelerated)
assert_true(plan1.full_scan == false)
assert_eq(#plan1.used_indexes, 2)
assert_eq(plan1.order_by, "-age")
assert_eq(plan1.limit, 2)

plan2 = users.explain(name__contains = "i")
assert_true(plan2.index_accelerated == false)
assert_true(plan2.full_scan)
assert_eq(#plan2.post_filters, 1)

plan3 = users.explain({
  any = {
    {team = "red"},
    {age__lt = 18}
  }
})
assert_true(plan3.has_group_logic)
assert_true(plan3.full_scan)

db.close()
gc
os.remove(base + "_users.db")
os.remove(base + "_users__idx_email.db")
os.remove(base + "_users__idx_team.db")
os.remove(base + "_users__idx_age.db")

print "db explain ok"
