from lib.test import assert_eq

s = "blabla"
out = ""
for c in s
  out = out + c
assert_eq(out, "blabla")

idx_sum = 0
out2 = ""
for i, c in "abc"
  idx_sum = idx_sum + i
  out2 = out2 + c
assert_eq(idx_sum, 6)
assert_eq(out2, "abc")

print "string iter ok"

from lib.test import assert_eq, assert_true

http = import http
string = import string

raw = "POST /echo HTTP/1.1\r\nHost: example\r\nContent-Length: 5\r\n\r\nhelloGET /next HTTP/1.1\r\nHost: example\r\n\r\n"
p = http.parse(raw)
assert_true(type(p) == "table")
assert_eq(p.method, "POST")
assert_eq(p.path, "/echo")
assert_eq(p.body, "hello")
assert_true(type(p.consumed) == "number")
assert_eq(string.sub(raw, p.consumed + 1), "GET /next HTTP/1.1\r\nHost: example\r\n\r\n")

incomplete_len = "POST /x HTTP/1.1\r\nHost: a\r\nContent-Length: 6\r\n\r\nabc"
assert_true(http.parse(incomplete_len) == nil)

invalid_len = "POST /x HTTP/1.1\r\nHost: a\r\nContent-Length: nope\r\n\r\nabc"
assert_true(http.parse(invalid_len) == false)

chunked = "POST /c HTTP/1.1\r\nHost: a\r\nTransfer-Encoding: chunked\r\n\r\n4\r\nWiki\r\n5\r\npedia\r\n0\r\n\r\nGET /n HTTP/1.1\r\nHost: a\r\n\r\n"
pc = http.parse(chunked)
assert_true(type(pc) == "table")
assert_eq(pc.path, "/c")
assert_eq(pc.body, "Wikipedia")
assert_eq(string.sub(chunked, pc.consumed + 1), "GET /n HTTP/1.1\r\nHost: a\r\n\r\n")

incomplete_chunked = "POST /c HTTP/1.1\r\nHost: a\r\nTransfer-Encoding: chunked\r\n\r\n4\r\nWiki\r\n0\r\n"
assert_true(http.parse(incomplete_chunked) == nil)

invalid_chunked = "POST /c HTTP/1.1\r\nHost: a\r\nTransfer-Encoding: chunked\r\n\r\nZ\r\nbad\r\n0\r\n\r\n"
assert_true(http.parse(invalid_chunked) == false)

print "http parse streaming ok"
