from lib.test import assert_eq, assert_true

binary = import binary

assert_true(binary.unpack(binary.pack(nil)) == nil)
assert_true(binary.unpack(binary.pack(true)) == true)
assert_true(binary.unpack(binary.pack(false)) == false)
assert_eq(binary.unpack(binary.pack(12.5)), 12.5)
assert_eq(binary.unpack(binary.pack("hello")), "hello")

payload = {
  10,
  20,
  ok = true,
  name = "toi",
  score = 9.25,
  nested = {x = 1, y = "z"},
  skip_fn = fn() return 1
}

packed = binary.pack(payload)
decoded = binary.unpack(packed)

assert_eq(decoded[1], 10)
assert_eq(decoded[2], 20)
assert_true(decoded.ok == true)
assert_eq(decoded.name, "toi")
assert_eq(decoded.score, 9.25)
assert_eq(decoded.nested.x, 1)
assert_eq(decoded.nested.y, "z")
assert_true(decoded.skip_fn == nil)

h = binary.hex(packed)
assert_true(type(h) == "string")
roundtrip = binary.unhex(h)
assert_true(roundtrip == packed)
assert_true(binary.unpack(roundtrip).name == "toi")

caught_hex = false
try
  binary.unhex("0xz1")
except e
  caught_hex = true
  assert_true(e has "invalid hex")
assert_true(caught_hex)

caught = false
try
  binary.unpack(packed + "x")
except e
  caught = true
  assert_true(e has "trailing data")
assert_true(caught)

print "binary ok"

from lib.test import assert_eq, assert_true

http_server = import lib.http_server
thread = import thread

fn wait_until_running(app, timeout_sec = 1.0)
  elapsed = 0.0
  while elapsed < timeout_sec
    if app.is_running()
      return true
    thread.sleep(0.01)
    elapsed = elapsed + 0.01
  return app.is_running()

fn run_and_stop(host, port, worker_threads = 0)
  app = http_server(port=port, host=host, worker_threads=worker_threads)
  h = thread.spawn(fn()
    return app.run()
  )
  assert_true(h != nil)

  assert_true(wait_until_running(app))
  assert_true(app.is_running() == true)

  assert_true(app.stop(0.1) == true)

  result = thread.join(h)
  assert_eq(result, "stopped")
  assert_true(app.is_running() == false)

run_and_stop("127.0.0.1", 0, 0)
run_and_stop("127.0.0.1", 0, 2)

print "http server stop ok"
