fn assert_true(cond, msg = nil)
  if not cond
    error(msg or "assert_true failed")

global time = import time
global string = import string

fn alloc_wave(count)
  for i in 1..count
    s = string.format("item_%d", i)
    t = string.format("%s_tmp", s)
    n = i + 1
    box = {s, t, n}
    pair = {left = box, right = {v = n}}
    box.self = pair

base = mem()
peak = base
rounds = 0

start = time.clock()
while time.clock() - start < 5.0
  alloc_wave(1200)
  rounds = rounds + 1
  now = mem()
  if now > peak
    peak = now
  if rounds % 500 == 0
    elapsed_now = time.clock() - start
    print string.format("soak progress: rounds=%d elapsed=%fs mem=%d peak=%d", rounds, elapsed_now, now, peak)

keep = {}
for i in 1..3000
  keep[i] = {v = i}

after = mem()
elapsed = time.clock() - start

print string.format("soak summary: rounds=%d elapsed=%fs base=%d peak=%d after=%d", rounds, elapsed, base, peak, after)

assert_true(elapsed >= 4.5, "soak test ended too early")
assert_true(rounds > 0, "no allocation rounds ran")
assert_true(peak <= base + 134217728, "memory growth too high during soak")
assert_true(after <= base + 134217728, "memory remained too high after churn")
assert_true(keep[1].v == 1)
assert_true(keep[3000].v == 3000)
