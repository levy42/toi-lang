from lib.test import assert_eq, assert_true

http_server = import lib.http_server

fn assert_has(haystack, needle)
  i, j = string.find(haystack, needle)
  if i == nil
    error("assert_has failed: missing '" + needle + "'")

string = import string
global coroutine = import coroutine

fn chunk_gen()
  yield "a"
  yield "b"
  yield "c"

app = http_server(port=0, host="127.0.0.1")
get = app.get

@get("/stream1")
fn stream1()
  return chunk_gen()

@get("/stream2")
fn stream2()
  return {status = 201, headers = {["X-Test"] = "1"}, stream = chunk_gen()}

@get("/stream3")
fn stream3()
  return {status = 202, body = chunk_gen()}

r1 = app.handler({method = "GET", path = "/stream1"})
assert_true(type(r1) == "table")
assert_true(r1.__stream == true)
assert_true(type(r1.stream) == "generator")

v1 = coroutine.resume(r1.stream)
v2 = coroutine.resume(r1.stream)
v3 = coroutine.resume(r1.stream)
assert_eq(v1, "a")
assert_eq(v2, "b")
assert_eq(v3, "c")

r2 = app.handler({method = "GET", path = "/stream2"})
assert_true(type(r2) == "table")
assert_true(r2.__stream == true)
assert_eq(r2.status, 201)
assert_eq(r2.headers["X-Test"], "1")

r3 = app.handler({method = "GET", path = "/stream3"})
assert_true(type(r3) == "table")
assert_true(r3.__stream == true)
assert_eq(r3.status, 202)

print "http streaming generators ok"
