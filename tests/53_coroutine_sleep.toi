from lib.test import assert_eq, assert_true

coroutine = import coroutine
Scheduler = import scheduler

fn sleeper()
  resumed = coroutine.sleep(0.01)
  return resumed

co = coroutine.create(sleeper)
ok, cmd, secs = coroutine.resume(co)
assert_true(ok)
assert_eq(cmd, "sleep")
assert_true(secs > 0)
assert_eq(coroutine.status(co), "normal")

ok2, resumed = coroutine.resume(co, "wake")
assert_true(ok2)
assert_eq(resumed, "wake")
assert_eq(coroutine.status(co), "dead")

events = {}
fn task_a()
  events[#events + 1] = "a1"
  coroutine.sleep(0.01)
  events[#events + 1] = "a2"

fn task_b()
  events[#events + 1] = "b1"

Scheduler.add(task_a)
Scheduler.add(task_b)
Scheduler.run()

assert_eq(events[1], "a1")
assert_eq(events[2], "b1")
assert_eq(events[3], "a2")

print "coroutine sleep ok"
