http_server = import lib.http_server
string = import string

fn assert_has(haystack, needle)
  i, j = string.find(haystack, needle)
  if i == nil
    error("assert_has failed")

app = http_server(port=0, host="127.0.0.1")
get = app.get
post = app.post

@get("/users/<id>")
fn get_user(id: int)
  return {id = id}

@post("/users/<id>")
fn post_user(id: int)
  return "ok " + str(id)

r1 = app.handler({method = "GET", path = "/users/42"})
assert_has(r1, "200 OK")
assert_has(r1, "\"id\":42")

r2 = app.handler({method = "POST", path = "/users/42"})
assert_has(r2, "200 OK")
assert_has(r2, "ok 42")

r3 = app.handler({method = "GET", path = "/users/nope"})
assert_has(r3, "400 Bad Request")
assert_has(r3, "int() expects")

r4 = app.handler({method = "DELETE", path = "/users/42"})
assert_has(r4, "405 Method Not Allowed")

r5 = app.handler({method = "GET", path = "/unknown"})
assert_has(r5, "404 Not Found")

print "http framework ok"
