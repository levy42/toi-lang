from lib.test import assert_eq, assert_true

flag = 0
try
  flag = 1
except e
  flag = 2
assert_eq(flag, 1)

try
  throw "boom"
except e
  assert_eq(e, "boom")

flag = 0
try
  flag = 1
finally
  flag = flag + 10
assert_eq(flag, 11)

flag = 0
try
  throw "boom2"
except e
  flag = 1
finally
  flag = flag + 10
assert_eq(flag, 11)

flag = 0
try
  try
    throw "boom3"
  finally
    flag = 1
except e
  assert_eq(e, "boom3")
  assert_eq(flag, 1)

flag = 0
try
  try
    throw "boom4"
  except e
    throw "boom5"
  finally
    flag = 1
except e
  assert_eq(e, "boom5")
  assert_eq(flag, 1)

matched = false
try
  throw {kind = "io", code = 7}
except e if type(e) == "table" and e.kind == "io" and e.code == 7
  matched = true
assert_true(matched)

forwarded_kind = nil
try
  try
    throw {kind = "other", code = 9}
  except e if type(e) == "table" and e.kind == "io"
    throw "should-not-run"
except ex
  forwarded_kind = ex.kind
assert_eq(forwarded_kind, "other")
