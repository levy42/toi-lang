from lib.test import assert_eq, assert_true

socket = import socket
selector = import lib.selector

sel = selector.new()
assert_eq(selector.read_count(sel), 0)
assert_eq(selector.write_count(sel), 0)

s = socket.udp()
assert_true(s != nil, "udp socket create failed")

selector.add_read(sel, s)
selector.add_write(sel, s)
assert_eq(selector.read_count(sel), 1)
assert_eq(selector.write_count(sel), 1)

local ready_read, ready_write = selector.wait(sel, 0.05)
assert_eq(type(ready_read), "table")
assert_eq(type(ready_write), "table")
assert_eq(#ready_read, 0)
assert_eq(#ready_write, 1)
assert_true(ready_write[1] == s)

selector.remove(sel, s)
assert_eq(selector.read_count(sel), 0)
assert_eq(selector.write_count(sel), 0)

selector.add_read(sel, s)
selector.clear(sel)
assert_eq(selector.read_count(sel), 0)

assert_true(s.close(s) == true)

print "selector ok"
