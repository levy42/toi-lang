<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Toi Libraries (`lib/*.toi`)</title><style>body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f6f7fb;color:#1d2433;}.wrap{display:grid;grid-template-columns:280px 1fr;min-height:100vh;}.side{padding:20px;border-right:1px solid #d9dce6;background:#fff;position:sticky;top:0;height:100vh;overflow:auto;}.side h1{font-size:16px;margin:0 0 12px 0;}.nav{list-style:none;margin:0;padding:0;}.nav li{margin:0;}.nav a{display:block;padding:7px 8px;border-radius:6px;color:#2b3550;text-decoration:none;font-size:14px;}.nav li.active a,.nav a:hover{background:#eef2ff;color:#1a3cff;}.main{max-width:980px;padding:28px 36px 56px 36px;}h1,h2,h3,h4,h5,h6{line-height:1.25;color:#0f172a;}p,li{line-height:1.6;color:#1f2937;}code{background:#eef1f7;padding:2px 5px;border-radius:5px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.92em;}pre{background:#0f172a;color:#e2e8f0;padding:14px;border-radius:10px;overflow:auto;}pre code{background:transparent;color:inherit;padding:0;}a{color:#1d4ed8;}blockquote{margin:12px 0;padding:6px 14px;border-left:4px solid #9aa7c7;background:#edf2ff;border-radius:4px;}table{border-collapse:collapse;margin:16px 0;width:100%;}th,td{border:1px solid #d2d8e5;padding:8px 10px;text-align:left;}th{background:#eef2ff;}hr{border:none;border-top:1px solid #d6dbe8;margin:24px 0;}@media (max-width:900px){.wrap{grid-template-columns:1fr}.side{position:static;height:auto;border-right:none;border-bottom:1px solid #d9dce6}}</style></head><body><div class="wrap"><aside class="side"><h1>Toi Docs</h1><ul class="nav"><li><a href="../stdlib/uuid.html">`uuid` Module</a></li><li><a href="../getting-started.html">Getting Started</a></li><li><a href="../language/control-flow.html">Control Flow</a></li><li><a href="../language/functions.html">Functions</a></li><li><a href="../language/modules.html">Modules and Imports</a></li><li><a href="../language/syntax.html">Language Syntax</a></li><li><a href="../language/types-and-values.html">Types and Values</a></li><li><a href="../repl.html">REPL</a></li><li><a href="../stdlib/README.html">Standard Library</a></li><li><a href="../stdlib/binary.html">`binary` Module</a></li><li><a href="../stdlib/btree.html">`btree` Module</a></li><li><a href="../stdlib/core.html">Core Built-ins</a></li><li><a href="../stdlib/coroutine.html">`coroutine` Module</a></li><li><a href="../stdlib/dir.html">`dir` Module</a></li><li><a href="../stdlib/fnmatch.html">`fnmatch` Module</a></li><li><a href="../stdlib/glob.html">`glob` Module</a></li><li><a href="../stdlib/gzip.html">gzip (optional)</a></li><li><a href="../stdlib/http.html">`http` Module</a></li><li><a href="../stdlib/inspect.html">`inspect` Module</a></li><li><a href="../stdlib/io.html">`io` Module</a></li><li><a href="../stdlib/json.html">`json` Module</a></li><li><a href="../stdlib/math.html">`math` Module</a></li><li><a href="../stdlib/mmap.html">`mmap` Module</a></li><li><a href="../stdlib/os.html">`os` Module</a></li><li><a href="../stdlib/poll.html">`poll` Module</a></li><li><a href="../stdlib/regex.html">`regex` Module</a></li><li><a href="../stdlib/signal.html">`signal` Module</a></li><li><a href="../stdlib/socket.html">`socket` Module</a></li><li><a href="../stdlib/stat.html">`stat` Module</a></li><li><a href="../stdlib/string.html">`string` Module</a></li><li><a href="../stdlib/struct.html">`struct` Module</a></li><li><a href="../stdlib/table.html">`table` Module</a></li><li><a href="../stdlib/template.html">`template` Module</a></li><li><a href="../stdlib/thread.html">`thread` Module</a></li><li><a href="../stdlib/time.html">`time` Module</a></li><li class="active"><a href="../stdlib/toi-libraries.html">Toi Libraries (`lib/*.toi`)</a></li><li><a href="../README.html">Toi Documentation</a></li></ul></aside><main class="main"><h1 id="toi-libraries-lib-toi">Toi Libraries (<code>lib/*.toi</code>)</h1>
<p>These are standard helper modules implemented in Toi itself.</p>
<h2 id="lib-test"><code>lib.test</code></h2>
<p>Testing helpers used by <code>tests/*.toi</code>:</p>
<ul>
<li><code>assert_eq(actual, expected, [msg])</code>
</li>
<li><code>assert_true(cond, [msg])</code>
</li>
<li><code>expect_error(fn_)</code>
</li>
<li><code>timeit(msg=&quot;timer&quot;, echo=false)</code>
</li>
</ul>
<h2 id="lib-types"><code>lib.types</code></h2>
<p>Runtime type-validation/composition helpers.</p>
<p>Provided constructors and helpers include:</p>
<ul>
<li>Primitive type defs: <code>String</code>, <code>Number</code>, <code>Boolean</code>, <code>Integer</code>
</li>
<li>Containers: <code>List(inner)</code>, <code>Optional(inner)</code>, <code>Record(schema, [opts])</code>
</li>
<li>Combinators: <code>Union(...)</code>, <code>Literal(...)</code>, <code>Constraints(inner, opts)</code>
</li>
<li>Validation/coercion helpers: <code>validate(type_def, value)</code>, <code>coerce(type_def, value)</code>, <code>from_hint(name)</code>
</li>
</ul>
<p>Primitive types are now callable with constraint/default metadata, which is sugar for wrapping with <code>Constraints(...)</code>.</p>
<p>Examples:</p>
<pre><code class="language-toi">types = import lib.types

short_name_t = types.String(max_len = 30, pattern = &quot;^[A-Z]&quot;)
adult_t = types.Integer(min = 18, max = 120)

profile_t = types.Record({
  name = types.String(default = &quot;Anonymous&quot;),
  age = types.Integer(default = 18)
})</code></pre>
<p>When a record field is missing, <code>Record.check(...)</code> applies the field&#39;s <code>default</code> (value or function) before validation.</p>
<p>See <code>tests/20_toi_libs.toi</code> and <code>tests/70_types_options_defaults.toi</code> for detailed usage.</p>
<h2 id="lib-cli"><code>lib.cli</code></h2>
<p>CLI application framework:</p>
<ul>
<li><code>App(opts)</code>
</li>
<li><code>app.command(...)</code> decorator/registration
</li>
<li><code>app.help()</code>
</li>
<li><code>app.run([argv])</code>
</li>
<li><code>printc(text)</code> ANSI-color helper
</li>
<li><code>status(msg, [opts])</code> spinner-style status line helper
</li>
<li><code>progress(total, [opts])</code> single-line progress bar helper
<ul>
<li>status and progress auto-spawn background updates by default when <code>thread</code> is available.
</li>
<li>status still supports manual <code>tick()</code> and explicit <code>start_auto([interval])</code>/<code>stop(...)</code> control.
</li>
<li>both expose context-manager hooks <code>__enter/__exit</code> for <code>with</code> blocks.
</li>
</ul>
</li>
</ul>
<h2 id="lib-scheduler"><code>lib.scheduler</code></h2>
<p>Cooperative scheduling utilities for coroutine-driven workflows.</p>
<h2 id="lib-path"><code>lib.path</code></h2>
<p>POSIX-style path helpers for common string path manipulation.</p>
<p>API:</p>
<ul>
<li><code>path.join(a, b)</code>
</li>
<li><code>path.split(path)</code> (returns non-empty segments)
</li>
<li><code>path.dirname(path)</code>
</li>
<li><code>path.basename(path)</code>
</li>
<li><code>path.normalize(path)</code> (collapses duplicate <code>/</code>, trims trailing <code>/</code> except root)
</li>
<li><code>path.is_abs(path)</code>
</li>
</ul>
<h2 id="lib-selector"><code>lib.selector</code></h2>
<p>Small readiness selector helper over native <code>poll</code> (with <code>socket.select</code> fallback).</p>
<p>Primary API:</p>
<ul>
<li><code>selector.new() -&gt; sel</code>
</li>
<li><code>selector.add_read(sel, sock)</code>
</li>
<li><code>selector.add_write(sel, sock)</code>
</li>
<li><code>selector.remove(sel, sock)</code>
</li>
<li><code>selector.clear(sel)</code>
</li>
<li><code>selector.wait(sel, [timeout_seconds]) -&gt; ready_read, ready_write</code>
</li>
</ul>
<h2 id="lib-log"><code>lib.log</code></h2>
<p>Minimal logging toolkit implemented in Toi.</p>
<p>Main API:</p>
<ul>
<li><code>log.Logger(name=&quot;root&quot;, opts={...})</code>
</li>
<li><code>log.get_logger(name=&quot;root&quot;)</code>
</li>
<li><code>log.configure(level=nil, handlers=nil, formatter=nil, context=nil)</code> (named args)
</li>
<li><code>log.trace/debug/info/warn/error(msg, [fields])</code> (root logger shortcuts)
</li>
<li><code>log.log(level, msg, [fields])</code>
</li>
</ul>
<p>Options:</p>
<ul>
<li><code>level</code> (<code>&quot;trace&quot;|&quot;debug&quot;|&quot;info&quot;|&quot;warn&quot;|&quot;error&quot;</code> or numeric)
</li>
<li><code>handlers</code> (array of <code>fn(record, line)</code> callbacks)
</li>
<li><code>formatter</code> (<code>fn(record) -&gt; string</code>)
</li>
<li><code>context</code> (table merged into all log records)
</li>
</ul>
<p>Built-in handlers:</p>
<ul>
<li><code>log.console_handler(record, line)</code> (prints line)
</li>
<li><code>log.file_handler(path, [append=true]) -&gt; handler</code>
</li>
</ul>
<h2 id="lib-http-server"><code>lib.http_server</code></h2>
<p>Simple HTTP server framework composed from:</p>
<ul>
<li><code>lib/http_server/__.toi</code>
</li>
<li><code>lib/http_server/route.toi</code>
</li>
<li><code>lib/http_server/response.toi</code>
</li>
<li><code>lib/http_server/transport.toi</code>
</li>
</ul>
<p>Provides routing helpers and response generation on top of native modules.</p>
<p>Constructor:</p>
<ul>
<li><code>http_server(opts={...})</code> (also exported as callable module)
</li>
<li>Backward-compatible: <code>http_server.new(port, [handler])</code>, <code>http_server.app(port)</code>
</li>
</ul>
<p>Common options:</p>
<ul>
<li><code>host</code> (default <code>&quot;0.0.0.0&quot;</code>)
</li>
<li><code>port</code> (default <code>8080</code>)
</li>
<li><code>handler</code> (custom request handler function)
</li>
<li><code>ssl</code> (<code>true</code> to enable TLS)
</li>
<li><code>ssl_cert</code> / <code>ssl_key</code> (required when <code>ssl=true</code>)
</li>
<li>certificate/key aliases: <code>cert</code> or <code>cert_path</code>, <code>key</code> or <code>key_path</code>
</li>
<li><code>worker_threads</code>, <code>worker_select_timeout</code>, <code>worker_queue_capacity</code>
</li>
<li><code>stop_grace_seconds</code>
</li>
<li><code>gc_every_requests</code>, <code>log_every_requests</code>, <code>trim_after_gc</code>
</li>
</ul>
<p>Routing and lifecycle methods:</p>
<ul>
<li><code>app.get(path)</code>, <code>app.post(path)</code>, <code>app.put(path)</code>, <code>app.patch(path)</code>, <code>app.delete(path)</code>
</li>
<li><code>app.route(method, path)</code> (decorator-style)
</li>
<li><code>app.serve_dir(dir_path, path, [gzip=false])</code> (static files)
</li>
<li><code>app.run()</code>
</li>
<li><code>app.stop([grace_sec])</code>
</li>
<li><code>app.is_running()</code>
</li>
</ul>
<p>HTTPS example:</p>
<pre><code class="language-toi">http_server = import lib.http_server

app = http_server(
  host = &quot;127.0.0.1&quot;,
  port = 8443,
  ssl = true,
  ssl_cert = &quot;tests/fixtures/tls/server.crt&quot;,
  ssl_key = &quot;tests/fixtures/tls/server.key&quot;
)

get = app.get
@get(&quot;/&quot;)
fn root(req)
  return &quot;ok over tls&quot;

app.run()</code></pre>
<p>Notes:</p>
<ul>
<li>TLS requires a build with OpenSSL support (<code>socket.tls_available()</code>).
</li>
<li>In TLS mode, accepted client sockets are handshaked with <code>sock.tls_server(...)</code> before request handling.
</li>
</ul>
<h2 id="lib-loadtest"><code>lib.loadtest</code></h2>
<p>Minimal HTTP/HTTPS load tester focused on requests-per-second.</p>
<p>File:</p>
<ul>
<li><code>lib/loadtest.toi</code>
</li>
</ul>
<p>CLI command:</p>
<ul>
<li><code>rps(url, duration_sec=10, concurrency=10, timeout_ms=2000, verify_tls=false)</code>
</li>
</ul>
<p>Example:</p>
<pre><code class="language-bash">./toi lib/loadtest.toi rps http://127.0.0.1:8080/ 10 20 2000 false</code></pre>
<p>Behavior notes:</p>
<ul>
<li>Uses plain TCP for <code>http://</code> and <code>socket.tls(...)</code> for <code>https://</code>.
</li>
<li>Classifies <code>2xx</code>/<code>3xx</code> responses as <code>ok</code>; everything else increments <code>fail</code>.
</li>
<li>Uses <code>thread</code> workers when available; otherwise falls back to concurrency <code>1</code>.
</li>
</ul></main></div></body></html>